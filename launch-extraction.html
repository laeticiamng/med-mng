<!DOCTYPE html>
<html>
<head>
    <title>Extraction OIC - 4,872 Comp√©tences</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }
        .log { margin: 5px 0; }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .info { color: #00bfff; }
        .progress { color: #ffff00; }
    </style>
</head>
<body>
    <h1>üöÄ EXTRACTION OIC - 4,872 COMP√âTENCES</h1>
    <div id="logs"></div>
    
    <script>
        const baseUrl = 'https://yaincoxihiqdksxgrsrk.supabase.co/functions/v1/extract-edn-objectifs';
        const anonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaW5jb3hpaGlxZGtzeGdyc3JrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI4MTE4MjcsImV4cCI6MjA1ODM4NzgyN30.HBfwymB2F9VBvb3uyeTtHBMZFZYXzL0wQmS5fqd65yU';
        
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${anonKey}`
        };

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('logs').appendChild(div);
            console.log(message);
        }

        async function startExtraction() {
            log('üß™ √âTAPE 1: Test d\'insertion des donn√©es...', 'info');
            
            // 1. Test d'insertion
            try {
                const testResponse = await fetch(baseUrl, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ action: 'insert_test_data' })
                });
                
                const testResult = await testResponse.json();
                log(`‚úÖ Test d'insertion: ${JSON.stringify(testResult)}`, 'success');
                
                if (!testResult.success) {
                    log('‚ùå Test d\'insertion √©chou√©', 'error');
                    return;
                }
                
                log('‚úÖ Test d\'insertion r√©ussi - Lancement extraction compl√®te', 'success');
                
            } catch (error) {
                log(`‚ùå Erreur test insertion: ${error.message}`, 'error');
                return;
            }

            log('üöÄ √âTAPE 2: Lancement de l\'extraction compl√®te...', 'info');
            
            // 2. Lancer l'extraction compl√®te
            try {
                const extractionResponse = await fetch(baseUrl, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ action: 'start' })
                });
                
                const extractionResult = await extractionResponse.json();
                log(`üéØ Extraction lanc√©e: ${JSON.stringify(extractionResult)}`, 'success');
                
                if (extractionResult.session_id) {
                    log(`üìä Session ID: ${extractionResult.session_id}`, 'info');
                    log('‚è∞ Monitoring du progr√®s...', 'info');
                    
                    // 3. Monitor le progr√®s
                    await monitorProgress(extractionResult.session_id);
                }
            } catch (error) {
                log(`‚ùå Erreur lancement extraction: ${error.message}`, 'error');
            }
        }

        async function monitorProgress(sessionId) {
            let attempts = 0;
            const maxAttempts = 120; // 60 minutes max
            
            while (attempts < maxAttempts) {
                try {
                    const statusResponse = await fetch(baseUrl, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({ 
                            action: 'status', 
                            session_id: sessionId 
                        })
                    });
                    
                    const status = await statusResponse.json();
                    const progressPercent = ((status.items_extracted / status.total_expected) * 100).toFixed(1);
                    
                    log(`üìà Progr√®s: ${status.items_extracted}/${status.total_expected} (${progressPercent}%) - Page ${status.page_number} - Status: ${status.status}`, 'progress');
                    
                    if (status.status === 'termine') {
                        log('üéâ EXTRACTION TERMIN√âE !', 'success');
                        await generateFinalReport();
                        break;
                    } else if (status.status === 'erreur') {
                        log(`‚ùå ERREUR LORS DE L'EXTRACTION: ${status.error_message}`, 'error');
                        break;
                    }
                    
                    // Attendre 30 secondes avant le prochain check
                    await new Promise(resolve => setTimeout(resolve, 30000));
                    attempts++;
                    
                } catch (error) {
                    log(`‚ùå Erreur monitoring: ${error.message}`, 'error');
                    attempts++;
                    await new Promise(resolve => setTimeout(resolve, 30000));
                }
            }
        }

        async function generateFinalReport() {
            log('üìä G√âN√âRATION DU RAPPORT FINAL...', 'info');
            
            try {
                const reportResponse = await fetch(baseUrl, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ action: 'rapport' })
                });
                
                const report = await reportResponse.json();
                
                log('üéØ RAPPORT FINAL D\'EXTRACTION OIC', 'success');
                log('==========================================', 'success');
                log(`‚úÖ Comp√©tences extraites: ${report.total_competences_extraites}`, 'success');
                log(`üéØ Comp√©tences attendues: ${report.total_competences_attendues}`, 'success');
                log(`üìà Completude globale: ${report.completude_globale}%`, 'success');
                log(`üìö Items EDN couverts: ${report.items_ern_couverts}`, 'success');
                
                // V√©rification finale SQL
                log('üîç V√©rification SQL: SELECT COUNT(*) FROM oic_competences', 'info');
                
            } catch (error) {
                log(`‚ùå Erreur g√©n√©ration rapport: ${error.message}`, 'error');
            }
        }

        // Auto-start extraction
        log('üöÄ INITIALISATION DE L\'EXTRACTION OIC', 'info');
        log('Credentials configur√©s avec CAS_USERNAME et CAS_PASSWORD', 'info');
        log('D√©marrage automatique dans 3 secondes...', 'info');
        
        setTimeout(() => {
            startExtraction();
        }, 3000);
    </script>
</body>
</html>