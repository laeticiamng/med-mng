name: Extract OIC Competences

on:
  workflow_dispatch:  # Lancement manuel
  schedule:
    - cron: '0 2 * * 0'  # Chaque dimanche √† 2h (optionnel)

jobs:
  diagnostic-api:
    runs-on: ubuntu-latest
    
    steps:
    - name: Test category API
      run: |
        echo "üîç Test API MediaWiki (1 r√©sultat) ..."
        curl -s 'https://livret.uness.fr/lisa/2025/api.php?action=query&list=categorymembers&cmtitle=Cat√©gorie:Objectif_de_connaissance&cmlimit=1&format=json&origin=*' | jq .
        
    - name: Test batch 50
      run: |
        echo "üìÑ Test 50 pages avec prop=revisions ..."
        # R√©cup√®re 50 pageids depuis la premi√®re requ√™te
        IDS=$(curl -s 'https://livret.uness.fr/lisa/2025/api.php?action=query&list=categorymembers&cmtitle=Cat√©gorie:Objectif_de_connaissance&cmlimit=50&format=json&origin=*' | jq -r '.query.categorymembers[].pageid' | paste -sd'|' -)
        echo "üî¢ Page IDs r√©cup√©r√©s: $IDS"
        if [ -n "$IDS" ]; then
          echo "üìñ Test r√©cup√©ration contenu de $IDS ..."
          curl -s "https://livret.uness.fr/lisa/2025/api.php?action=query&prop=revisions&rvprop=content|timestamp&format=json&origin=*&pageids=${IDS}&formatversion=2" | jq '.query.pages | length'
        else
          echo "‚ùå Aucun ID r√©cup√©r√© - probl√®me avec la cat√©gorie"
        fi

  extract:
    runs-on: ubuntu-latest
    needs: diagnostic-api
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm install puppeteer @supabase/supabase-js dotenv
    
    - name: Run OIC extraction
      env:
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        CAS_USERNAME: ${{ secrets.CAS_USERNAME }}
        CAS_PASSWORD: ${{ secrets.CAS_PASSWORD }}
      run: |
        node extract-oic-competences.cjs
    
    - name: Upload extraction report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: extraction-report
        path: |
          rapport-*.json
          extraction-*.log