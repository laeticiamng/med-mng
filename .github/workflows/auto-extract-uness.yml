name: ğŸš€ Extraction Automatique UNESS

on:
  # Lancement manuel
  workflow_dispatch:
    inputs:
      extraction_type:
        description: 'Type d\'extraction'
        required: true
        default: 'complete'
        type: choice
        options:
        - complete
        - edn
        - oic
        - ecos
      
  # Lancement automatique quotidien Ã  2h du matin
  schedule:
    - cron: '0 2 * * *'
    
  # Lancement sur push vers main (optionnel)
  push:
    branches: [ main ]
    paths: 
      - 'supabase/functions/extract-uness-enhanced/**'

env:
  SUPABASE_URL: https://yaincoxihiqdksxgrsrk.supabase.com
  SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaW5jb3hpaGlxZGtzeGdyc3JrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI4MTE4MjcsImV4cCI6MjA1ODM4NzgyN30.HBfwymB2F9VBvb3uyeTtHBMZFZYXzL0wQmS5fqd65yU

jobs:
  extract-uness-data:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 heures max
    
    steps:
    - name: ğŸš€ DÃ©marrage de l'extraction
      run: |
        echo "ğŸ¤– Extraction automatique UNESS dÃ©marrÃ©e"
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ¯ Type: ${{ github.event.inputs.extraction_type || 'complete' }}"
        
    - name: ğŸ“Š Lancement extraction EDN
      if: ${{ github.event.inputs.extraction_type == 'edn' || github.event.inputs.extraction_type == 'complete' || github.event.inputs.extraction_type == '' }}
      run: |
        echo "ğŸ“š Lancement extraction EDN..."
        curl -X POST "$SUPABASE_URL/functions/v1/extract-uness-enhanced" \
          -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
          -H "Content-Type: application/json" \
          -d '{
            "action": "start",
            "extraction_type": "edn",
            "batch_size": 50,
            "max_concurrent": 6
          }' \
          --max-time 30 || echo "âŒ Timeout EDN - processus continue en arriÃ¨re-plan"
          
    - name: â³ Pause entre les extractions
      if: ${{ github.event.inputs.extraction_type == 'complete' || github.event.inputs.extraction_type == '' }}
      run: sleep 10
      
    - name: ğŸ¯ Lancement extraction OIC
      if: ${{ github.event.inputs.extraction_type == 'oic' || github.event.inputs.extraction_type == 'complete' || github.event.inputs.extraction_type == '' }}
      run: |
        echo "ğŸ¯ Lancement extraction OIC (4,872 compÃ©tences)..."
        curl -X POST "$SUPABASE_URL/functions/v1/extract-uness-enhanced" \
          -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
          -H "Content-Type: application/json" \
          -d '{
            "action": "start",
            "extraction_type": "oic",
            "batch_size": 100,
            "max_concurrent": 10
          }' \
          --max-time 30 || echo "âŒ Timeout OIC - processus continue en arriÃ¨re-plan"
          
    - name: â³ Pause entre les extractions
      if: ${{ github.event.inputs.extraction_type == 'complete' || github.event.inputs.extraction_type == '' }}
      run: sleep 10
      
    - name: ğŸ¥ Lancement extraction ECOS
      if: ${{ github.event.inputs.extraction_type == 'ecos' || github.event.inputs.extraction_type == 'complete' || github.event.inputs.extraction_type == '' }}
      run: |
        echo "ğŸ¥ Lancement extraction ECOS..."
        curl -X POST "$SUPABASE_URL/functions/v1/extract-uness-enhanced" \
          -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
          -H "Content-Type: application/json" \
          -d '{
            "action": "start",
            "extraction_type": "ecos",
            "batch_size": 30,
            "max_concurrent": 5
          }' \
          --max-time 30 || echo "âŒ Timeout ECOS - processus continue en arriÃ¨re-plan"
    
    - name: ğŸ“Š Monitoring des extractions
      run: |
        echo "ğŸ“Š Les extractions continuent en arriÃ¨re-plan sur Supabase Edge Functions"
        echo "âœ… Toutes les extractions ont Ã©tÃ© lancÃ©es avec succÃ¨s"
        echo "ğŸ” Consultez les logs Supabase pour le suivi dÃ©taillÃ©"
        
    - name: ğŸ‰ RÃ©sumÃ© final
      run: |
        echo "ğŸ‰ EXTRACTION AUTOMATIQUE TERMINÃ‰E"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“š EDN: Items de connaissance lancÃ©s"
        echo "ğŸ¯ OIC: 4,872 compÃ©tences en cours"
        echo "ğŸ¥ ECOS: Situations cliniques lancÃ©es"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âš¡ Les processus continuent de faÃ§on asynchrone"
        echo "ğŸ“Š VÃ©rifiez Supabase Dashboard pour les rÃ©sultats"