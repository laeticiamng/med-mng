name: 🚀 Extraction Automatique UNESS

on:
  # Lancement manuel
  workflow_dispatch:
    inputs:
      extraction_type:
        description: 'Type d\'extraction'
        required: true
        default: 'complete'
        type: choice
        options:
        - complete
        - edn
        - oic
        - ecos
      
  # Lancement automatique quotidien à 2h du matin
  schedule:
    - cron: '0 2 * * *'
    
  # Lancement sur push vers main (optionnel)
  push:
    branches: [ main ]
    paths: 
      - 'supabase/functions/extract-uness-enhanced/**'

env:
  SUPABASE_URL: https://yaincoxihiqdksxgrsrk.supabase.com
  SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaW5jb3hpaGlxZGtzeGdyc3JrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI4MTE4MjcsImV4cCI6MjA1ODM4NzgyN30.HBfwymB2F9VBvb3uyeTtHBMZFZYXzL0wQmS5fqd65yU

jobs:
  extract-uness-data:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 heures max
    
    steps:
    - name: 🚀 Démarrage de l'extraction
      run: |
        echo "🤖 Extraction automatique UNESS démarrée"
        echo "📅 Date: $(date)"
        echo "🎯 Type: ${{ github.event.inputs.extraction_type || 'complete' }}"
        
    - name: 📊 Lancement extraction EDN
      if: ${{ github.event.inputs.extraction_type == 'edn' || github.event.inputs.extraction_type == 'complete' || github.event.inputs.extraction_type == '' }}
      run: |
        echo "📚 Lancement extraction EDN..."
        curl -X POST "$SUPABASE_URL/functions/v1/extract-uness-enhanced" \
          -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
          -H "Content-Type: application/json" \
          -d '{
            "action": "start",
            "extraction_type": "edn",
            "batch_size": 50,
            "max_concurrent": 6
          }' \
          --max-time 30 || echo "❌ Timeout EDN - processus continue en arrière-plan"
          
    - name: ⏳ Pause entre les extractions
      if: ${{ github.event.inputs.extraction_type == 'complete' || github.event.inputs.extraction_type == '' }}
      run: sleep 10
      
    - name: 🎯 Lancement extraction OIC
      if: ${{ github.event.inputs.extraction_type == 'oic' || github.event.inputs.extraction_type == 'complete' || github.event.inputs.extraction_type == '' }}
      run: |
        echo "🎯 Lancement extraction OIC (4,872 compétences)..."
        curl -X POST "$SUPABASE_URL/functions/v1/extract-uness-enhanced" \
          -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
          -H "Content-Type: application/json" \
          -d '{
            "action": "start",
            "extraction_type": "oic",
            "batch_size": 100,
            "max_concurrent": 10
          }' \
          --max-time 30 || echo "❌ Timeout OIC - processus continue en arrière-plan"
          
    - name: ⏳ Pause entre les extractions
      if: ${{ github.event.inputs.extraction_type == 'complete' || github.event.inputs.extraction_type == '' }}
      run: sleep 10
      
    - name: 🏥 Lancement extraction ECOS
      if: ${{ github.event.inputs.extraction_type == 'ecos' || github.event.inputs.extraction_type == 'complete' || github.event.inputs.extraction_type == '' }}
      run: |
        echo "🏥 Lancement extraction ECOS..."
        curl -X POST "$SUPABASE_URL/functions/v1/extract-uness-enhanced" \
          -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
          -H "Content-Type: application/json" \
          -d '{
            "action": "start",
            "extraction_type": "ecos",
            "batch_size": 30,
            "max_concurrent": 5
          }' \
          --max-time 30 || echo "❌ Timeout ECOS - processus continue en arrière-plan"
    
    - name: 📊 Monitoring des extractions
      run: |
        echo "📊 Les extractions continuent en arrière-plan sur Supabase Edge Functions"
        echo "✅ Toutes les extractions ont été lancées avec succès"
        echo "🔍 Consultez les logs Supabase pour le suivi détaillé"
        
    - name: 🎉 Résumé final
      run: |
        echo "🎉 EXTRACTION AUTOMATIQUE TERMINÉE"
        echo "════════════════════════════════════"
        echo "📚 EDN: Items de connaissance lancés"
        echo "🎯 OIC: 4,872 compétences en cours"
        echo "🏥 ECOS: Situations cliniques lancées"
        echo "════════════════════════════════════"
        echo "⚡ Les processus continuent de façon asynchrone"
        echo "📊 Vérifiez Supabase Dashboard pour les résultats"